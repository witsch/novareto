<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="nva.borrow">

    <metal:slot fill-slot="style_slot">
        <style type="text/css">
            /* initial states items available or not */
            .items-available {
                color: green;
                font-weight: bold;
            }            

            .no-items-available {
                color: red;
            }

            .item-date-cell {
                text-align: center;
            }            
            
            .selected {
                background-color: #eeeeee;
            }            
        </style>

    </metal:slot>

<body>

<metal:main fill-slot="content-core">
    <metal:content-core define-macro="content-core" 
          tal:define="data python: view.getDateRange(num_days=60)">

        <script type="text/javascript" tal:content="string:ISO_DATES = ${data/dates_iso}"></script>  
        <h2>Ordner form</h2>      

        Borrow for how many days: <input type="number" min="1" max="5" id="days" name="days" value="1" />
        <table id="order-table" border="1">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Number items</th>
                    <tal:loop repeat="mmyy data/months">
                        <th tal:attributes="colspan python: len(data['month_year'][mmyy])"
                            tal:content="string:${mmyy/monthname} ${mmyy/year}" />
                    </tal:loop>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td tal:repeat="dt data/dates" style="width: 20px; text-align: center">
                        <span tal:replace="string: ${dt/weekday_name} ${dt/day}" />
                        <input class="date-selector" 
                            type="checkbox" 
                            tal:attributes="value dt/isoformat;
                                            id string:date-selector-${dt/isoformat}" />
                    </td>
                </tr>
                <tr tal:repeat="item view/getItems">
                    <td>
                        <a tal:attributes="href item/absolute_url" tal:content="item/Title" />
                    </td>
                    <td>
                        <input type="number"
                               class="item-number-selector"
                               min="0"
                               max="5" 
                               style="width: 50px"
                               tal:define="id item/@@getIntId"
                               tal:attributes="name string:number-items-$id;
                                               id   string:number-items-$id;
                                               data-item-id id"
                               value="0"
                               maxlength="1"
                               size="1"
                        />
                    </td>
                    <td tal:repeat="dt data/dates"
                        tal:define="cssItemsAvailable python: 'items-available' if item.itemsAvailable >0 else 'no-items-available'"
                        tal:attributes="class string:item-date-cell $cssItemsAvailable weekday-${dt/weekday_name/lower};
                                        data-items-available item/itemsAvailable;
                                        data-date dt/isoformat;
                                        data-item item/@@getIntId;
                                        data-items-booked string:0;
                                        data-active string:0;
                                        id string:item-${item/@@getIntId}-${dt/isoformat}
                                        "
                        tal:content="item/itemsAvailable"
                        >
                    </td>
                </tr>
            </tbody>
        </table>

        <script type="text/javascript">

            function clear_grid(date_checked) {
                $('.item-date-cell').removeClass('selected');
                $('.item-date-cell').attr('data-active', '0');
                $('.date-selector').attr('checked', false);
            }

            function update_grid(reference_date) {
                clear_grid();

                var days = $('#days').val();
                var date_idx = ISO_DATES.indexOf(reference_date);
                for (var i=0; i<days; i++) {
                    var current_date = ISO_DATES[date_idx+i];
                    $("td[data-date='" + current_date + "']").addClass('selected');
                    $("td[data-date='" + current_date + "']").attr('data-active', '1');
                }
                $('#date-selector-' + reference_date).attr('checked', true);
            }


            $(document).ready(function() {

                $('input.date-selector').bind('click', function() {
                    var checked = $(this).is(':checked');
                    var date = $(this).attr('value');
                    if (checked) {
                        update_grid(date);
                    }
                    else {
                        clear_grid();
                    }
                });
                
                $('#days').bind('change', function() {
                    var days = $(this).val();
                    // find reference date (with checkbox checked)
                    var ref_cbs = $('input[type="checkbox"]:checked');
                    if (ref_cbs.length > 0) {
                        var ref_date = ref_cbs[0].value;
                        update_grid(ref_date);
                    }
                });
                
                $('.item-number-selector').bind('change', function() {
                    var num_items = $(this).val();
                    var item_id = $(this).attr('data-item-id');
                    console.log('checking:', num_items, item_id);
                    $('.item-date-cell[data-item="'+item_id+'"]').each(function() {
                        if ($(this).attr('data-active') == '1') {
                            $(this).html(num_items);
                        }
                    });
                });
            });
        </script>


    </metal:content-core>
</metal:main>

</body>
</html>

